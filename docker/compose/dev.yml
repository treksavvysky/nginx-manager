# Development Docker Compose Configuration
# For local development and testing

services:
  # NGINX Manager API
  nginx-manager-api:
    build:
      context: ../..
      dockerfile: docker/api/Dockerfile
    container_name: nginx-manager-api
    ports:
      - "8000:8000"
    volumes:
      # Mount configuration directories (rw for CRUD operations)
      - ../../test-configs:/etc/nginx/conf.d
      - ../../data/ssl:/etc/ssl
      - ../../data/api-logs:/var/log/nginx-manager
      - ../../data/api-backups:/var/backups/nginx
      # ACME challenge directory for Let's Encrypt
      - ../../data/acme-challenge:/var/www/.well-known/acme-challenge
      # Development: mount source code for hot reload
      - ../../api:/app/api
      # Mount tests directory for running tests
      - ../../tests:/app/tests
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - API_DEBUG=true
      - API_RELOAD=true
      - NGINX_CONF_DIR=/etc/nginx/conf.d
      - NGINX_CONTAINER_NAME=nginx-manager-nginx
      - LOG_LEVEL=DEBUG
    networks:
      - nginx-manager
    depends_on:
      - nginx-manager-nginx
    restart: unless-stopped

  # NGINX Web Server
  nginx-manager-nginx:
    build:
      context: ../nginx
      dockerfile: Dockerfile
    container_name: nginx-manager-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # Share configuration with API
      - ../../test-configs:/etc/nginx/conf.d:ro
      - ../../data/ssl:/etc/ssl
      - ../../data/nginx-logs:/var/log/nginx
      # Website content directory
      - ../../www:/var/www
      # ACME challenge directory for Let's Encrypt
      - ../../data/acme-challenge:/var/www/.well-known/acme-challenge
    networks:
      - nginx-manager
    restart: unless-stopped

  # Optional: Web UI for development (future)
  # nginx-manager-ui:
  #   image: nginx:alpine
  #   container_name: nginx-manager-ui
  #   ports:
  #     - "3000:80"
  #   networks:
  #     - nginx-manager

networks:
  nginx-manager:
    driver: bridge
    name: nginx-manager-network
